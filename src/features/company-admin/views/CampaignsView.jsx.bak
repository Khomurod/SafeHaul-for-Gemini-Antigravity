import React, { useState, useEffect, useMemo } from 'react';
import { httpsCallable } from 'firebase/functions';
import { functions, db, auth } from '@lib/firebase';
import { onAuthStateChanged } from 'firebase/auth';
import {
    collection, query, where, getDocs, orderBy,
    limit, onSnapshot, doc, Timestamp
} from 'firebase/firestore';
import { useToast } from '@shared/components/feedback/ToastProvider';
import {
    Send, Users, MessageSquare, AlertCircle,
    CheckCircle, Info, Filter, Mail,
    Clock, ChevronRight, Play, Search,
    FileText, History, Activity, Loader2,
    Eye, Calendar, UserCheck, RefreshCcw, Megaphone
} from 'lucide-react';

// Multi-select status list for precision filtering
const APP_STATUSES = [
    "New Application", "Contacted", "Interview Scheduled", "Offer Sent",
    "Offer Accepted", "Approved", "Hired", "Rejected", "Disqualified", "Stale"
];

const LEAD_STATUSES = [
    "New Lead", "Contacted", "Follow Up Needed", "Not Interested", "Rejected"
];

const CALL_OUTCOMES = [
    "Connected / Interested",
    "Connected / Scheduled Callback",
    "Connected / Not Qualified",
    "Connected / Not Interested",
    "Connected / Hired Elsewhere",
    "Left Voicemail",
    "No Answer",
    "Wrong Number"
];

export function CampaignsView({ companyId }) {
    const { showSuccess, showError } = useToast();

    // 1. NAVIGATION & LAYOUT
    const [view, setView] = useState('create'); // 'create', 'history', 'report'
    const [isLoading, setIsLoading] = useState(false);
    const [currentUser, setCurrentUser] = useState(null);
    const [isAuthLoading, setIsAuthLoading] = useState(true);

    // Track Auth State
    useEffect(() => {
        return onAuthStateChanged(auth, (user) => {
            setCurrentUser(user);
            setIsAuthLoading(false);
        });
    }, []);

    // 2. FILTERING & AUDIENCE
    const [filters, setFilters] = useState({
        recruiterId: 'my_leads',
        status: [], // Multi-select array
        leadType: 'applications', // 'applications', 'leads', 'global'
        limit: 50,
        lastCallOutcome: 'all'
    });

    const [previewLeads, setPreviewLeads] = useState([]);
    const [isPreviewLoading, setIsPreviewLoading] = useState(false);
    const [matchCount, setMatchCount] = useState(0);
    const [previewError, setPreviewError] = useState(null);
    const [teamMembers, setTeamMembers] = useState([]);

    // 3. MESSAGE & CHANNEL
    const [messageConfig, setMessageConfig] = useState({
        method: 'sms',
        subject: '',
        message: "Hi [Driver Name], we haven't heard from you in a while! Are you still looking for a driving job? Reply YES to reactivate your application.",
        interval: 15
    });

    // 4. SESSIONS & REPORTING
    const [pastSessions, setPastSessions] = useState([]);
    const [activeSession, setActiveSession] = useState(null);
    const [selectedSessionId, setSelectedSessionId] = useState(null);
    const [selectedSessionAttempts, setSelectedSessionAttempts] = useState([]);

    // 5. TEMPLATES
    const [templates, setTemplates] = useState([]);
    const [showSaveTemplateModal, setShowSaveTemplateModal] = useState(false);
    const [newTemplateName, setNewTemplateName] = useState('');

    // --- DATA FETCHING ---

    // Fetch Templates
    useEffect(() => {
        const fetchTemplates = async () => {
            if (!companyId || !currentUser) return;
            try {
                const result = await httpsCallable(functions, 'getTemplates')({ companyId });
                if (result.data.success) {
                    setTemplates(result.data.templates);
                }
            } catch (err) { console.error("Template fetch error:", err); }
        };
        fetchTemplates();
    }, [companyId, currentUser]);

    // Fetch Team for Recruiter Filter
    useEffect(() => {
        const fetchTeam = async () => {
            if (!companyId || !currentUser) return;
            try {
                const q = query(collection(db, 'memberships'), where('companyId', '==', companyId));
                const snap = await getDocs(q);
                const uids = snap.docs.map(d => d.data().userId);
                if (uids.length > 0) {
                    const usersSnap = await getDocs(query(collection(db, 'users'), where('__name__', 'in', uids.slice(0, 10))));
                    setTeamMembers(usersSnap.docs.map(d => ({ id: d.id, ...d.data() })));
                }
            } catch (err) { console.error("Team fetch error:", err); }
        };
        fetchTeam();
    }, [companyId, currentUser]);

    // Live Audience Preview (Draft Mode)
    useEffect(() => {
        let isCancelled = false;
        const fetchPreview = async () => {
            if (!currentUser || !companyId || isAuthLoading) return;
            setIsPreviewLoading(true);
            setPreviewError(null);
            try {
                let baseRef;
                if (filters.leadType === 'global') {
                    baseRef = collection(db, 'leads');
                } else if (filters.leadType === 'leads') {
                    baseRef = query(collection(db, 'companies', companyId, 'leads'), where('isPlatformLead', '==', true));
                } else {
                    baseRef = collection(db, 'companies', companyId, 'applications');
                }

                let q = query(baseRef);

                // 1. Status Filter
                if (filters.status && filters.status.length > 0 && filters.status !== 'all') {
                    q = query(q, where('status', 'in', filters.status));
                }

                // 2. Recruiter Filter (Using active currentUser)
                if (filters.recruiterId === 'my_leads') {
                    q = query(q, where('assignedTo', '==', currentUser.uid));
                } else if (filters.recruiterId && filters.recruiterId !== 'all') {
                    q = query(q, where('assignedTo', '==', filters.recruiterId));
                }

                // 3. Created After Filter
                if (filters.createdAfter) {
                    const date = new Date(filters.createdAfter);
                    q = query(q, where('createdAt', '>=', Timestamp.fromDate(date)));
                }

                // 4. Not Contacted Since Filter
                if (filters.notContactedSince) {
                    const days = parseInt(filters.notContactedSince);
                    const date = new Date();
                    date.setDate(date.getDate() - days);
                    q = query(q, where('lastContactedAt', '<=', Timestamp.fromDate(date)));
                }

                // 5. Last Call Outcome Filter (Mirroring Phase 8 Mapping)
                if (filters.lastCallOutcome && filters.lastCallOutcome !== 'all') {
                    if (filters.leadType === 'global') {
                        const outcomeMap = {
                            "Connected / Interested": "interested",
                            "Connected / Scheduled Callback": "callback",
                            "Connected / Not Qualified": "not_qualified",
                            "Connected / Not Interested": "not_interested",
                            "Connected / Hired Elsewhere": "hired_elsewhere",
                            "Left Voicemail": "voicemail",
                            "No Answer": "no_answer",
                            "Wrong Number": "wrong_number"
                        };
                        const outcomeId = outcomeMap[filters.lastCallOutcome];
                        if (outcomeId) q = query(q, where('lastOutcome', '==', outcomeId));
                    } else {
                        q = query(q, where('lastCallOutcome', '==', filters.lastCallOutcome));
                    }
                }

                // --- NEW: FETCH COUNT ---
                const { getCountFromServer } = await import('firebase/firestore');
                const countSnap = await getCountFromServer(q);
                if (!isCancelled) setMatchCount(countSnap.data().count);

                const snap = await getDocs(query(q, limit(filters.limit)));
                if (!isCancelled) {
                    setPreviewLeads(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }
            } catch (err) {
                console.error("Preview error:", err);
                if (!isCancelled) {
                    setPreviewLeads([]);
                    setMatchCount(0);
                    // Show helpful error for missing indexes
                    if (err.message?.includes('index') || err.message?.includes('permission-denied')) {
                        setPreviewError(err.message);
                        showError("Filter error: " + (err.message.includes('index') ? "A new database index is required for this combination." : "Permission denied."));
                    }
                }
            } finally {
                if (!isCancelled) setIsPreviewLoading(false);
            }
        };

        const timer = setTimeout(fetchPreview, 500); // Debounce
        return () => { isCancelled = true; clearTimeout(timer); };
    }, [filters, companyId, currentUser, isAuthLoading]);

    // Global Session Monitoring
    useEffect(() => {
        if (!companyId || !currentUser) return;
        const q = query(
            collection(db, 'companies', companyId, 'bulk_sessions'),
            orderBy('createdAt', 'desc'),
            limit(15)
        );
        return onSnapshot(q, (snapshot) => {
            const sessions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            setPastSessions(sessions);
            const active = sessions.find(s => ['active', 'queued', 'paused'].includes(s.status));
            setActiveSession(active || null);
        });
    }, [companyId]);

    // Report Detail Monitoring
    useEffect(() => {
        if (!selectedSessionId || view !== 'report' || !currentUser) return;
        const q = query(
            collection(db, 'companies', companyId, 'bulk_sessions', selectedSessionId, 'attempts'),
            orderBy('timestamp', 'desc')
        );
        return onSnapshot(q, (snapshot) => {
            setSelectedSessionAttempts(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
        });
    }, [selectedSessionId, view, companyId]);

    // --- ACTIONS ---

    const handleLaunch = async () => {
        if (previewLeads.length === 0) return showError("No drivers found matching filters.");
        setIsLoading(true);
        try {
            const initFn = httpsCallable(functions, 'initBulkSession');
            // Pass scheduledFor (if set in filters) to backend
            const payload = {
                companyId,
                filters: {
                    ...filters,
                    status: filters.status, // Ensure array or string
                },
                messageConfig,
                scheduledFor: filters.scheduledFor || null
            };

            const result = await initFn(payload);
            if (result.data.success) {
                if (result.data.status === 'scheduled') {
                    showSuccess(`Campaign Scheduled for ${new Date(filters.scheduledFor).toLocaleString()}`);
                    // Optionally clear schedule
                    setFilters(prev => ({ ...prev, scheduledFor: '' }));
                } else {
                    showSuccess(`Action Processed: ${result.data.targetCount} drivers queued.`);
                    setSelectedSessionId(result.data.sessionId);
                    setView('report');
                }
            } else {
                showError(result.data.message || "Initialization failed.");
            }
        } catch (err) { showError(err.message); }
        finally { setIsLoading(false); }
    };

    // --- SESSION CONTROLS ---

    const handlePauseSession = async (session) => {
        try {
            await httpsCallable(functions, 'pauseBulkSession')({ companyId, sessionId: session.id });
            showSuccess("Session Paused");
        } catch (err) { showError(err.message); }
    };

    const handleResumeSession = async (session) => {
        try {
            await httpsCallable(functions, 'resumeBulkSession')({ companyId, sessionId: session.id });
            showSuccess("Session Resumed");
        } catch (err) { showError(err.message); }
    };

    const handleCancelSession = async (session) => {
        if (!window.confirm("Are you sure you want to cancel this campaign? This cannot be undone.")) return;
        try {
            await httpsCallable(functions, 'cancelBulkSession')({ companyId, sessionId: session.id });
            showSuccess("Session Cancelled");
        } catch (err) { showError(err.message); }
    };

    const handleRetryFailed = async () => {
        if (!window.confirm("Retry all failed delivery attempts?")) return;
        setIsLoading(true);
        try {
            const result = await httpsCallable(functions, 'retryFailedAttempts')({
                companyId,
                originalSessionId: selectedSessionId,
                newMessageConfig: null // Use original config
            });
            if (result.data.success) {
                showSuccess(`Retry initiated for ${result.data.targetCount} targets.`);
                setSelectedSessionId(result.data.sessionId); // Switch report view to new session
            } else {
                showError(result.data.message);
            }
        } catch (err) { showError(err.message); }
        finally { setIsLoading(false); }
    };

    const handleExportCSV = async () => {
        if (!selectedSessionAttempts.length) return showError("No data to export.");

        const headers = ["Recipient Name", "Identity", "Status", "Error", "Timestamp"];
        const rows = selectedSessionAttempts.map(att => [
            att.recipientName,
            att.recipientIdentity,
            att.status,
            att.error || '',
            att.timestamp?.toDate().toLocaleString() || ''
        ]);

        const csvContent = [
            headers.join(','),
            ...rows.map(r => r.map(c => `"${c}"`).join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `campaign_report_${selectedSessionId}.csv`;
        link.click();
    };

    // --- MODALS ---
    const ConfirmLaunchModal = ({ onClose, onConfirm, count, method, scheduledFor }) => (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white rounded-[2.5rem] p-10 max-w-lg w-full shadow-2xl scale-100 animate-in zoom-in-95 duration-200">
                <div className="flex flex-col items-center text-center space-y-6">
                    <div className="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 mb-2">
                        <Play size={32} className="ml-1" />
                    </div>
                    <div>
                        <h3 className="text-2xl font-black text-slate-900 uppercase tracking-tight">
                            {scheduledFor ? 'Confirm Schedule' : 'Confirm Launch'}
                        </h3>
                        <p className="text-slate-500 font-medium mt-2">
                            You are about to {scheduledFor ? 'schedule' : 'queue'} <strong>{count}</strong> {method === 'sms' ? 'SMS messages' : 'Emails'}.
                            {scheduledFor && (
                                <span className="block mt-2 text-blue-600 font-bold">
                                    Target: {new Date(scheduledFor).toLocaleString()}
                                </span>
                            )}
                            <br />{!scheduledFor && "This action requires carrier compliance checks."}
                        </p>
                    </div>
                    <div className="flex gap-4 w-full pt-4">
                        <button onClick={onClose} className="flex-1 py-4 bg-slate-100 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-200 transition-colors">Cancel</button>
                        <button onClick={onConfirm} className="flex-1 py-4 bg-blue-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl hover:bg-blue-700 transition-colors">
                            {scheduledFor ? 'Schedule Now' : 'Launch Campaign'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
    const [showConfirmModal, setShowConfirmModal] = useState(false);

    const onLaunchClick = () => {
        if (previewLeads.length === 0) return showError("No drivers matching filters.");
        setShowConfirmModal(true);
    };



    const TabButton = ({ id, label, icon: Icon }) => (
        <button
            onClick={() => setView(id)}
            className={`px-8 py-3.5 rounded-3xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2 ${view === id ? 'bg-slate-900 text-white shadow-xl scale-105' : 'text-slate-400 hover:bg-white'}`}
        >
            <Icon size={14} /> {label}
        </button>
    );

    const CreateView = () => (
        <div className="flex flex-col lg:flex-row gap-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/* Sidebar: Audience Controls */}
            <aside className="lg:w-96 flex-shrink-0 space-y-6">
                <div className="bg-white border border-slate-200 rounded-[2.5rem] p-8 shadow-sm scale-100">
                    <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-8 flex items-center gap-2">
                        <Filter size={14} /> Targeting Wizard
                    </h3>

                    <div className="space-y-8">
                        {/* 1. Source */}
                        <div>
                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-tighter mb-3 ml-1 flex items-center gap-1.5">
                                Target Group
                            </label>
                            <div className="grid grid-cols-1 gap-2">
                                {[
                                    { id: 'applications', label: 'Company Apps', icon: UserCheck, color: 'blue' },
                                    { id: 'leads', label: 'Assigned SafeHaul', icon: Users, color: 'indigo' },
                                    { id: 'global', label: 'Global Network', icon: Megaphone, color: 'purple' }
                                ].map(s => (
                                    <button
                                        key={s.id}
                                        onClick={() => setFilters(prev => ({ ...prev, leadType: s.id, status: [] }))}
                                        className={`flex items-center gap-3 p-3 rounded-2xl border-2 transition-all ${filters.leadType === s.id ? `border-${s.color}-500 bg-${s.color}-50/30 text-${s.color}-700` : 'border-slate-50 bg-slate-50 text-slate-400 hover:border-slate-200'}`}
                                    >
                                        <s.icon size={18} />
                                        <span className="text-xs font-black uppercase tracking-tight">{s.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* 2. Recruiter */}
                        <div>
                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-tighter mb-3 ml-1">Assigned Recruiter</label>
                            <select
                                value={filters.recruiterId}
                                onChange={e => setFilters(prev => ({ ...prev, recruiterId: e.target.value }))}
                                className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold text-slate-700 outline-none focus:ring-4 focus:ring-blue-50/50 appearance-none transition-all cursor-pointer"
                            >
                                <option value="my_leads">Filter: My Leads Only</option>
                                <option value="all">Filter: All Team Leads</option>
                                {teamMembers.map(m => <option key={m.id} value={m.id}>Colleague: {m.name || m.email}</option>)}
                            </select>
                        </div>

                        {/* 3. Status (Multi-Select) */}
                        <div>
                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-tighter mb-3 ml-1">Driver Status (Multi-Select)</label>
                            <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-1 pr-2 custom-scrollbar">
                                {(filters.leadType === 'applications' ? APP_STATUSES : LEAD_STATUSES).map(st => (
                                    <button
                                        key={st}
                                        onClick={() => {
                                            setFilters(prev => {
                                                const has = prev.status.includes(st);
                                                return { ...prev, status: has ? prev.status.filter(s => s !== st) : [...prev.status, st] };
                                            })
                                        }}
                                        className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all border ${filters.status.includes(st) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-400 border-slate-100 hover:border-blue-200'}`}
                                    >
                                        {st}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* 4. Advanced Filters (Phase 5) */}
                        <div className="pt-4 border-t border-slate-50">
                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 block">Advanced Filters</label>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Created After</label>
                                    <input
                                        type="date"
                                        value={filters.createdAfter || ''}
                                        onChange={e => setFilters(prev => ({ ...prev, createdAfter: e.target.value }))}
                                        className="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-xs font-bold text-slate-700 outline-none"
                                    />
                                    <div>
                                        <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Not Contacted (Days)</label>
                                        <input
                                            type="number"
                                            min="0"
                                            placeholder="e.g 7 Days"
                                            value={filters.notContactedSince || ''}
                                            onChange={e => setFilters(prev => ({ ...prev, notContactedSince: e.target.value }))}
                                            className="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-xs font-bold text-slate-700 outline-none"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Last Call Result</label>
                                        <select
                                            value={filters.lastCallOutcome || 'all'}
                                            onChange={e => setFilters(prev => ({ ...prev, lastCallOutcome: e.target.value }))}
                                            className="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-xs font-bold text-slate-700 outline-none"
                                        >
                                            <option value="all">Any Outcome</option>
                                            {CALL_OUTCOMES.map(o => <option key={o} value={o}>{o}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 5. Limit */}
                        <div>
                            <div className="flex justify-between items-center mb-3">
                                <label className="text-[10px] font-black text-slate-500 uppercase tracking-tighter ml-1">Target Volume</label>
                                <span className="text-xs font-black text-blue-600 tracking-widest">{filters.limit} Drivers</span>
                            </div>
                            <input
                                type="range" min="1" max="100" step="5"
                                value={filters.limit}
                                onChange={e => setFilters(prev => ({ ...prev, limit: parseInt(e.target.value) }))}
                                className="w-full h-2 bg-slate-100 rounded-full appearance-none cursor-pointer accent-blue-600"
                            />
                            <div className="mt-2 text-[10px] font-bold text-slate-400 uppercase tracking-tight flex justify-between items-center px-1">
                                <span>Actual Matches:</span>
                                <span className={matchCount > 0 ? "text-green-600" : "text-slate-400"}>{matchCount} Drivers</span>
                            </div>
                        </div>
                    </div>

                    <div className="mt-10 pt-8 border-t border-slate-50">
                        <div className="flex items-center justify-between mb-4">
                            <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                <Users size={14} /> Live Audience Preview
                            </h4>
                            {isPreviewLoading && <Loader2 size={12} className="animate-spin text-blue-500" />}
                        </div>
                        <div className="space-y-2 max-h-[250px] overflow-y-auto pr-2 custom-scrollbar">
                            {previewError ? (
                                <div className="p-4 bg-red-50 border border-red-100 rounded-2xl text-[10px] font-medium text-red-600 leading-relaxed italic">
                                    <AlertCircle size={14} className="mb-2" />
                                    {previewError}
                                </div>
                            ) : previewLeads.length === 0 ? (
                                <div className="text-center py-8 text-slate-300 italic text-[10px]">No matches found for currently active filters.</div>
                            ) : (
                                previewLeads.map(l => (
                                    <div key={l.id} className="p-3 bg-slate-50/50 border border-slate-100 rounded-xl flex items-center justify-between">
                                        <div>
                                            <div className="text-[11px] font-black text-slate-700 uppercase tracking-tighter">{l.firstName || 'Unknown'} {l.lastName || ''}</div>
                                            <div className="text-[9px] font-bold text-slate-400 font-mono tracking-tight">{l.phone || l.phoneNumber || 'NO_PHONE'}</div>
                                        </div>
                                        <div className="text-[8px] font-black px-2 py-0.5 bg-white border border-slate-100 rounded-full text-blue-500 uppercase tracking-tighter">
                                            {l.status || 'New'}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            </aside >

            {/* Main: Composition & Launch */}
            < main className="flex-1 space-y-6" >
                {/* Method Switcher */}
                < div className="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl shadow-slate-200 flex flex-col md:flex-row items-center gap-8 border border-white/5" >
                    <div className="flex-1">
                        <h2 className="text-3xl font-black tracking-tight leading-tight">Delivery Protocol</h2>
                        <p className="text-slate-400 text-sm font-medium mt-1">Select the verified multi-channel routing logic.</p>
                    </div>
                    <div className="flex gap-4 p-2.5 bg-white/5 rounded-[2rem] border border-white/10 backdrop-blur-md">
                        <button
                            onClick={() => setMessageConfig(prev => ({ ...prev, method: 'sms' }))}
                            className={`px-10 py-5 rounded-2xl flex items-center gap-3 transition-all ${messageConfig.method === 'sms' ? 'bg-blue-600 text-white shadow-2xl scale-105' : 'text-slate-400 hover:bg-white/5'}`}
                        >
                            <MessageSquare size={22} />
                            <span className="text-[10px] font-black uppercase tracking-widest">Mobile SMS</span>
                        </button>
                        <button
                            onClick={() => setMessageConfig(prev => ({ ...prev, method: 'email' }))}
                            className={`px-10 py-5 rounded-2xl flex items-center gap-3 transition-all ${messageConfig.method === 'email' ? 'bg-indigo-600 text-white shadow-2xl scale-105' : 'text-slate-400 hover:bg-white/5'}`}
                        >
                            <Mail size={22} />
                            <span className="text-[10px] font-black uppercase tracking-widest">Direct Email</span>
                        </button>
                    </div>
                </div >

                {/* Content Editor */}
                < div className="bg-white border border-slate-200 rounded-[2.5rem] p-10 shadow-sm space-y-8" >

                    {/* Template Controls (Phase 3) */}
                    < div className="flex items-center gap-4 p-4 bg-slate-50 border border-slate-100 rounded-2xl" >
                        <div className="flex-1">
                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-1 block">Load Saved Template</label>
                            <select
                                onChange={(e) => {
                                    const t = templates.find(temp => temp.id === e.target.value);
                                    if (t) {
                                        setMessageConfig(prev => ({
                                            ...prev,
                                            method: t.method,
                                            subject: t.subject || prev.subject,
                                            message: t.message
                                        }));
                                    }
                                }}
                                className="w-full bg-transparent text-sm font-bold text-slate-700 outline-none cursor-pointer"
                            >
                                <option value="">Select a template...</option>
                                {templates.map(t => (
                                    <option key={t.id} value={t.id}>{t.name} ({t.method})</option>
                                ))}
                            </select>
                        </div>
                        <button
                            onClick={() => setShowSaveTemplateModal(true)}
                            className="px-6 py-3 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-blue-600 hover:bg-blue-50 transition-colors shadow-sm"
                        >
                            Save Current
                        </button>
                    </div >

                    {
                        messageConfig.method === 'email' && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Subject Header</h4>
                                <input
                                    type="text"
                                    placeholder="Email Subject Line..."
                                    value={messageConfig.subject}
                                    onChange={e => setMessageConfig(prev => ({ ...prev, subject: e.target.value }))}
                                    className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-lg font-bold text-slate-800 outline-none focus:ring-4 focus:ring-blue-100 transition-all font-sans"
                                />
                            </div>
                        )
                    }

                    < div className="space-y-4" >
                        <div className="flex justify-between items-center px-1">
                            <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Body Composition</h4>
                            <div className="flex items-center gap-2">
                                <span className={`text-[10px] font-black uppercase ${messageConfig.message.length > 160 ? 'text-orange-500' : 'text-slate-300'}`}>
                                    {messageConfig.message.length} Chars
                                </span>
                                {messageConfig.method === 'sms' && (
                                    <span className={`px-2 py-0.5 rounded-full text-[8px] font-black uppercase ${Math.ceil(messageConfig.message.length / 160) > 1 ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-400'}`}>
                                        {Math.ceil(messageConfig.message.length / 160)} Segment(s)
                                    </span>
                                )}
                            </div>
                        </div>
                        <textarea
                            value={messageConfig.message}
                            onChange={e => setMessageConfig(prev => ({ ...prev, message: e.target.value }))}
                            className="w-full h-56 p-8 bg-slate-50 border border-slate-100 rounded-[2rem] text-xl font-bold text-slate-800 outline-none focus:ring-8 focus:ring-blue-50/50 resize-none leading-relaxed transition-all placeholder:text-slate-300"
                            placeholder="Draft your automated transmission protocol..."
                        />
                    </div >

                    <div className="flex flex-wrap gap-3">
                        {['[Driver Name]', '[Company Name]', '[Recruiter Name]'].map(tag => (
                            <button
                                key={tag}
                                onClick={() => setMessageConfig(prev => ({ ...prev, message: prev.message + ` ${tag} ` }))}
                                className="px-5 py-2.5 bg-blue-50 text-blue-600 text-[10px] font-black rounded-2xl hover:bg-blue-600 hover:text-white transition-all uppercase tracking-widest border border-blue-100 shadow-sm hover:shadow-lg active:scale-95"
                            >
                                {tag}
                            </button>
                        ))}
                    </div>

                    {/* Scheduling UI (Phase 4) */}
                    <div className="bg-slate-50 border border-slate-100 p-8 rounded-[2rem] space-y-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 bg-white border border-slate-100 rounded-xl flex items-center justify-center text-slate-600 shadow-sm">
                                    <Calendar size={20} />
                                </div>
                                <div>
                                    <h5 className="text-sm font-black text-slate-900 uppercase tracking-tight">Schedule Execution</h5>
                                    <p className="text-[10px] text-slate-400 font-bold uppercase">Optional: Delay Transmission</p>
                                </div>
                            </div>
                            <input
                                type="datetime-local"
                                value={filters.scheduledFor || ''}
                                onChange={e => setFilters(prev => ({ ...prev, scheduledFor: e.target.value }))}
                                className="p-3 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-700 outline-none"
                            />
                        </div>
                    </div>

                    <div className="bg-slate-50 border border-slate-100 p-8 rounded-[2rem] flex items-center gap-6">
                        <div className="w-16 h-16 bg-white border border-slate-100 rounded-2xl flex items-center justify-center text-blue-600 shadow-sm">
                            <Clock size={32} />
                        </div>
                        <div className="flex-1">
                            <h5 className="text-sm font-black text-slate-900 uppercase tracking-tight mb-1 flex items-center gap-2">
                                Durable Execution Engine <span className="px-2 py-0.5 bg-green-100 text-green-600 text-[8px] rounded-full">Active</span>
                            </h5>
                            <p className="text-xs text-slate-500 font-medium leading-relaxed max-w-lg">
                                This session is server-anchored. Closing this window will **NOT** stop the transmission. Carrier-compliance logic (15s delay) is strictly enforced for SMS stability.
                            </p>
                        </div>
                    </div>

                    <button
                        onClick={onLaunchClick}
                        disabled={isLoading || previewLeads.length === 0}
                        className="w-full py-6 mt-4 bg-blue-600 text-white rounded-[2rem] font-black uppercase tracking-widest text-sm shadow-2xl shadow-blue-200 hover:bg-blue-700 active:scale-[0.98] transition-all flex items-center justify-center gap-4 disabled:opacity-50 disabled:shadow-none"
                    >
                        {isLoading ? <Loader2 className="animate-spin" size={20} /> : <Play size={20} />}
                        {filters.scheduledFor ? 'Schedule Campaign' : 'Execute Multi-Point Campaign'}
                    </button>

                    {
                        showConfirmModal && (
                            <ConfirmLaunchModal
                                onClose={() => setShowConfirmModal(false)}
                                onConfirm={() => { setShowConfirmModal(false); handleLaunch(); }}
                                count={previewLeads.length}
                                method={messageConfig.method}
                                scheduledFor={filters.scheduledFor}
                            />
                        )
                    }

                    {
                        showSaveTemplateModal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-in fade-in duration-200">
                                <div className="bg-white rounded-[2rem] p-8 max-w-sm w-full shadow-2xl scale-100 animate-in zoom-in-95 duration-200">
                                    <h3 className="text-lg font-black text-slate-900 uppercase tracking-tight mb-4">Save Template</h3>
                                    <input
                                        autoFocus
                                        type="text"
                                        placeholder="Template Name (e.g., Re-engagement V1)"
                                        value={newTemplateName}
                                        onChange={e => setNewTemplateName(e.target.value)}
                                        className="w-full p-4 bg-slate-50 border border-slate-100 rounded-xl text-sm font-bold text-slate-800 outline-none focus:ring-4 focus:ring-blue-50/50 mb-6"
                                    />
                                    <div className="flex gap-3">
                                        <button onClick={() => setShowSaveTemplateModal(false)} className="flex-1 py-3 bg-slate-100 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-200">Cancel</button>
                                        <button
                                            onClick={async () => {
                                                if (!newTemplateName) return;
                                                try {
                                                    await httpsCallable(functions, 'createTemplate')({
                                                        companyId,
                                                        name: newTemplateName,
                                                        method: messageConfig.method,
                                                        subject: messageConfig.subject,
                                                        message: messageConfig.message
                                                    });
                                                    showSuccess("Template Saved");
                                                    setNewTemplateName('');
                                                    setShowSaveTemplateModal(false);
                                                    // Refresh templates
                                                    const res = await httpsCallable(functions, 'getTemplates')({ companyId });
                                                    if (res.data.success) setTemplates(res.data.templates);
                                                } catch (err) { showError(err.message); }
                                            }}
                                            className="flex-1 py-3 bg-blue-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-blue-700"
                                        >
                                            Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                </div >
            </main >
        </div >
    );


    const HistoryView = () => (
        <div className="space-y-8 animate-in fade-in slide-in-from-bottom-8 duration-700">
            {activeSession && (
                <div className="bg-slate-900 rounded-[3rem] p-10 text-white relative overflow-hidden shadow-2xl border border-white/5">
                    <div className="absolute top-0 right-0 p-12 opacity-5 pointer-events-none">
                        <Activity size={200} />
                    </div>
                    <div className="relative z-10 flex flex-col md:flex-row items-center gap-10">
                        <div className="flex-1 space-y-3 text-center md:text-left">
                            <h3 className="text-3xl font-black uppercase tracking-tight flex items-center justify-center md:justify-start gap-4">
                                <span className="w-4 h-4 bg-blue-500 rounded-full animate-ping flex-shrink-0" /> Live Session Pipeline
                            </h3>
                            <p className="text-slate-400 font-medium text-lg leading-relaxed">
                                Executing {activeSession.leadSourceType} campaign. <br />
                                Currently at unit **{activeSession.progress.processedCount}** of **{activeSession.progress.totalCount}**.
                            </p>
                        </div>
                        <div className="flex-shrink-0 flex gap-4">
                            {activeSession.status === 'paused' ? (
                                <button
                                    onClick={() => handleResumeSession(activeSession)}
                                    className="px-8 py-4 bg-green-500/10 hover:bg-green-500/20 text-green-400 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all border border-green-500/20"
                                >
                                    Resume Transmission
                                </button>
                            ) : (
                                <button
                                    onClick={() => handlePauseSession(activeSession)}
                                    className="px-8 py-4 bg-white/10 hover:bg-white/20 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all"
                                >
                                    Pause Transmission
                                </button>
                            )}
                            <button
                                onClick={() => handleCancelSession(activeSession)}
                                className="px-8 py-4 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all border border-red-500/20"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={() => handleViewReport(activeSession)}
                                className="px-8 py-4 bg-white text-slate-900 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl hover:scale-105 transition-all"
                            >
                                Monitoring Dashboard
                            </button>
                        </div>
                    </div>

                    {/* Progress Visualizer */}
                    <div className="mt-12 space-y-4">
                        <div className="flex justify-between text-[10px] font-black uppercase tracking-widest text-slate-500">
                            <span>Engine Synchronization</span>
                            <span>{Math.round((activeSession.progress.processedCount / activeSession.progress.totalCount) * 100)}% Synchronized</span>
                        </div>
                        <div className="w-full h-4 bg-white/5 rounded-full border border-white/10 overflow-hidden">
                            <div
                                className="h-full bg-gradient-to-r from-blue-600 via-blue-400 to-blue-600 bg-[length:400%_100%] animate-gradient transition-all duration-1000 shadow-[0_0_30px_rgba(37,99,235,0.4)]"
                                style={{ width: `${(activeSession.progress.processedCount / activeSession.progress.totalCount) * 100}%` }}
                            />
                        </div>
                        <p className="text-[10px] text-slate-600 italic text-center uppercase tracking-widest opacity-60">Session remains active until carrier acknowledgement is received for all points.</p>
                    </div>
                </div>
            )}

            <div className="bg-white border border-slate-200 rounded-[3rem] overflow-hidden shadow-sm">
                <div className="p-10 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
                    <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <History size={18} /> Central Campaign Ledger
                    </h3>
                </div>
                <div className="overflow-x-auto overflow-y-hidden">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-white border-b border-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <tr>
                                <th className="p-10">Timestamp</th>
                                <th className="p-10">Protocol & Target</th>
                                <th className="p-10">Efficiency Index</th>
                                <th className="p-10">Session Integrity</th>
                                <th className="p-10 text-right">Insight</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50 font-sans">
                            {pastSessions.map(sess => (
                                <tr key={sess.id} className="hover:bg-slate-50/50 transition-all group">
                                    <td className="p-10">
                                        <div className="text-sm font-black text-slate-900 uppercase tracking-tighter leading-none mb-1">{sess.createdAt?.toDate().toLocaleDateString()}</div>
                                        <div className="text-[10px] font-bold text-slate-400 uppercase">{sess.createdAt?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                                    </td>
                                    <td className="p-10">
                                        <div className="flex items-center gap-3">
                                            <span className={`text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-tighter border ${sess.config.method === 'sms' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-indigo-50 text-indigo-600 border-indigo-100'}`}>
                                                {sess.config.method}
                                            </span>
                                            <span className="text-xs font-bold text-slate-500 uppercase tracking-tighter">/ {sess.leadSourceType}</span>
                                        </div>
                                        <div className="mt-2 text-[10px] font-black text-slate-300 uppercase truncate max-w-[150px]">"{sess.config.message}"</div>
                                    </td>
                                    <td className="p-10">
                                        <div className="flex items-center gap-8">
                                            <div className="space-y-1">
                                                <div className="text-[9px] font-bold text-slate-400 uppercase">Confirmed</div>
                                                <div className="text-2xl font-black text-green-600 leading-none">{sess.progress.successCount}</div>
                                            </div>
                                            <div className="space-y-1">
                                                <div className="text-[9px] font-bold text-slate-400 uppercase">Dropped</div>
                                                <div className="text-2xl font-black text-red-500 leading-none">{sess.progress.failedCount}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td className="p-10">
                                        <div className={`text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-2xl inline-block border ${sess.status === 'completed' ? 'bg-green-50 text-green-700 border-green-100' : sess.status === 'active' ? 'bg-blue-50 text-blue-700 border-blue-100 animate-pulse' : 'bg-slate-50 text-slate-400 border-slate-100'}`}>
                                            {sess.status}
                                        </div>
                                    </td>
                                    <td className="p-10 text-right">
                                        <button
                                            onClick={() => handleViewReport(sess)}
                                            className="p-4 bg-white border border-slate-100 rounded-2xl text-slate-400 hover:text-blue-600 hover:border-blue-300 shadow-sm transition-all hover:scale-110"
                                        >
                                            <Eye size={20} />
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );

    const ReportView = () => {
        const sess = pastSessions.find(s => s.id === selectedSessionId);
        if (!sess) return <div className="p-20 text-center text-slate-300 italic">Retreiving session intelligence...</div>;

        return (
            <div className="space-y-10 animate-in fade-in slide-in-from-right-12 duration-500">
                {/* Dash Actions */}
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                    <button
                        onClick={() => setView('history')}
                        className="group flex items-center gap-3 text-slate-400 hover:text-slate-900 font-black text-xs uppercase tracking-widest transition-all"
                    >
                        <div className="w-10 h-10 bg-white border border-slate-100 rounded-xl flex items-center justify-center group-hover:border-slate-300">
                            <ChevronRight className="rotate-180" size={18} />
                        </div>
                        Protocol History
                    </button>
                    <div className="flex gap-4">
                        <button
                            onClick={handleExportCSV}
                            className="px-8 py-4 bg-white border border-slate-200 rounded-2xl text-[10px] font-black uppercase tracking-widest text-slate-600 hover:bg-slate-50 shadow-sm transition-all flex items-center gap-3"
                        >
                            <FileText size={16} className="text-slate-400" /> Export Campaign Result
                        </button>
                        <button
                            onClick={handleRetryFailed}
                            className="px-8 py-4 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 shadow-xl transition-all flex items-center gap-3 active:scale-95"
                        >
                            <RefreshCcw size={16} /> Re-Execute Failed
                        </button>
                    </div>
                </div>

                {/* Dashboard Metrics */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div className="md:col-span-1 bg-white border border-slate-200 rounded-[3rem] p-10 shadow-sm space-y-6">
                        <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Session Identity</div>
                        <div className="space-y-1">
                            <h4 className="text-xl font-black text-slate-900 uppercase tracking-tighter">Campaign ID: {sess.id.substring(0, 8)}</h4>
                            <p className="text-xs font-bold text-slate-400 uppercase flex items-center gap-2">
                                <Calendar size={12} /> {sess.createdAt?.toDate().toLocaleString()}
                            </p>
                        </div>
                        <div className="pt-6 border-t border-slate-50 space-y-4">
                            <div className="flex justify-between items-end">
                                <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Saturation</span>
                                <span className="text-2xl font-black text-slate-900">{Math.round((sess.progress.processedCount / sess.progress.totalCount) * 100)}%</span>
                            </div>
                            <div className="w-full h-2.5 bg-slate-50 rounded-full overflow-hidden">
                                <div
                                    className="h-full bg-blue-600 transition-all duration-1000"
                                    style={{ width: `${(sess.progress.processedCount / sess.progress.totalCount) * 100}%` }}
                                />
                            </div>
                        </div>
                    </div>

                    <div className="bg-green-600 rounded-[3rem] p-10 text-white shadow-2xl shadow-green-100 flex flex-col justify-between">
                        <div className="text-[10px] font-black uppercase tracking-widest opacity-60">Delivered Success</div>
                        <div className="text-7xl font-black tracking-tighter">{sess.progress.successCount}</div>
                        <div className="text-xs font-bold uppercase tracking-widest opacity-80 pt-4 flex items-center gap-2">
                            <CheckCircle size={14} /> carrier_ack_confirmed
                        </div>
                    </div>

                    <div className="bg-white border border-slate-200 rounded-[3rem] p-10 shadow-sm flex flex-col justify-between">
                        <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Blocked / Errored</div>
                        <div className="text-7xl font-black text-red-500 tracking-tighter">{sess.progress.failedCount}</div>
                        <div className="text-xs font-bold text-slate-400 uppercase tracking-widest pt-4 flex items-center gap-2">
                            <AlertCircle size={14} className="text-red-400" /> requires_man_audit
                        </div>
                    </div>
                </div>

                {/* Granular Audit Trail */}
                <div className="bg-white border border-slate-200 rounded-[3rem] overflow-hidden shadow-sm">
                    <div className="p-10 border-b border-slate-50 bg-slate-50/20 flex justify-between items-center">
                        <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <Activity size={18} /> Lead Attribution Audit (Point-by-Point)
                        </h3>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left font-sans">
                            <thead className="bg-white border-b border-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                <tr>
                                    <th className="p-10">Recipient</th>
                                    <th className="p-10">Endpoint Intelligence</th>
                                    <th className="p-10">Transmission Clock</th>
                                    <th className="p-10">Session Response</th>
                                    <th className="p-10">Technical Diagnosis</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-50">
                                {selectedSessionAttempts.map((att, idx) => (
                                    <tr key={att.id || idx} className="hover:bg-slate-50/50 transition-colors">
                                        <td className="p-10">
                                            <div className="text-sm font-black text-slate-900 uppercase tracking-tighter leading-none mb-1">{att.recipientName}</div>
                                            <div className="text-[9px] font-black text-slate-300 uppercase tracking-widest">ID: {att.leadId.substring(0, 8)}</div>
                                        </td>
                                        <td className="p-10 font-mono text-[10px] font-bold text-slate-500 uppercase">{att.recipientIdentity}</td>
                                        <td className="p-10 text-[11px] font-black text-slate-400 uppercase">
                                            {att.timestamp?.toDate().toLocaleTimeString()}
                                        </td>
                                        <td className="p-10">
                                            <span className={`text-[9px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest border shadow-sm ${att.status === 'delivered' ? 'bg-green-50 text-green-700 border-green-100' : 'bg-red-50 text-red-700 border-red-100'}`}>
                                                {att.status}
                                            </span>
                                        </td>
                                        <td className="p-10 max-w-[300px]">
                                            <div className="text-xs font-bold text-slate-400 italic leading-relaxed">
                                                {att.status === 'delivered' ? 'ACK_OK: Point-to-point delivery confirmed via secure gate.' : att.error || 'UNNAMED_FAULT: Transmission aborted by carrier protocol.'}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {selectedSessionAttempts.length === 0 && (
                            <div className="p-20 text-center">
                                <Loader2 className="animate-spin mx-auto text-blue-500 mb-4" size={40} />
                                <div className="text-slate-300 font-black uppercase text-xs tracking-widest">Synchronizing Entry Logs...</div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const handleViewReport = (sess) => {
        setSelectedSessionId(sess.id);
        setView('report');
    };

    // --- MAIN WRAPPER ---
    return (
        <div className="bg-transparent space-y-10 min-h-[900px] pb-20">
            {/* Action Bar */}
            <header className="flex flex-col md:flex-row justify-between items-center gap-8 bg-white border border-slate-200 p-10 rounded-[3rem] shadow-sm">
                <div className="space-y-1 text-center md:text-left">
                    <h1 className="text-4xl font-black text-slate-900 uppercase tracking-tighter flex items-center justify-center md:justify-start gap-4">
                        <div className="w-14 h-14 bg-blue-600 rounded-[1.25rem] flex items-center justify-center text-white shadow-2xl shadow-blue-200">
                            <Megaphone size={32} />
                        </div>
                        Transmission Control
                    </h1>
                    <p className="text-sm text-slate-500 font-medium tracking-tight">Enterprise Multi-Channel Campaign Orchestration Engine v4.1</p>
                </div>

                <div className="flex gap-4 p-2.5 bg-slate-50 rounded-[2.5rem] border border-slate-100">
                    <TabButton id="create" label="New Session" icon={Play} />
                    <TabButton id="history" label="Session Audit" icon={History} />
                </div>
            </header>

            {/* View Switching Logic */}
            <div className="max-w-[1700px] mx-auto">
                {view === 'create' && <CreateView />}
                {view === 'history' && <HistoryView />}
                {view === 'report' && <ReportView />}
            </div>
        </div>
    );
}
